<!DOCTYPE html> 
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AfterSchoolLessons</title>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="afterclass.webmanifest"> 

</head>

<body>
    <div id="app">
        <header>
            <a href="#" class="logo" @click.prevent="goHome">Home</a>
            <h1 v-text="sitename"></h1>

            <div>
                <label for="search">Search:</label>
                <input type="text" v-model="searchQuery" placeholder="Search by subject or location..." @input="filterBooks" />
            </div>

            <button v-on:click="showCheckout" :disabled="cart.length === 0">
                {{ cart.length }} <span class="bi bi-cart"></span> Checkout
            </button>

        </header>

        <main>

            <div>
                <label for="sortBy">Sort By:</label>
                <select v-model="sortBy" @change="sortBooks">
                    <option value="subject">Subject</option>
                    <option value="Location">Location</option>
                    <option value="Price">Price</option>
                    <option value="Spaces">Availability (Spaces)</option>
                </select>
                <select v-model="sortOrder" @change="sortBooks">
                    <option value="asc">Ascending</option>
                    <option value="desc">Descending</option>
                </select>
            </div>

            <div v-if="showBook" class="grid-container">
                <div v-for="book in filteredBooks" :key="book.subject" class="card">
                    <figure>
                        <img v-bind:src="book.image" alt="book image">
                    </figure>
                    <h2 v-text="book.subject"></h2>
                    <p>Location: {{ book.Location }}</p>
                    <p>Price: ${{ book.Price }}</p>
                    <P>Spaces: {{ book.Spaces - cartCount(book.subject, book.Location) }}</P>
                    <button v-on:click="addToCart(book)" v-if="canAddToCart(book)">
                        Add to cart
                    </button>
                    <button disabled v-else>
                        Add to cart
                    </button>
                    <span v-if="book.Spaces === cartCount(book.subject, book.Location)">
                        Sorry, this item is SOLD OUT!
                    </span>
                    <span v-else-if="book.Spaces - cartCount(book.subject, book.Location) < 5">
                        Only {{ book.Spaces - cartCount(book.subject, book.Location) }} left!
                    </span>
                    <span v-else>Buy now!</span>
                    <div>
                        <span v-for="n in book.rating">★</span>
                        <span v-for="n in 5 - book.rating">☆</span>
                    </div>
                </div>
            </div>

            <div v-else>
                <h2>Checkout</h2>
                <div v-if="cart.length > 0" class="grid-container">
                    <div v-for="(subject, index) in addedSubjects" :key="index">
                        <div v-if="firstBookPicker(subject)" :key="firstBookPicker(subject).subject" class="card">
                            <figure>
                                <img class="card-img" v-bind:src=" firstBookPicker(subject).image" width="200" height="200">
                            </figure>
                            <div class="card-body">
                                <h5 class="card-title">{{ subject }}</h5>
                                <p>Location: {{ firstBookPicker(subject).Location }}</p>
                                <p>Price: ${{ firstBookPicker(subject).Price }}</p>
                                <p>Spaces: {{ uniqueBookCount(subject) }}</p>
                                <button class="btn btn-danger" @click="removeFromCart(subject)">Remove</button>
                            </div>
                        </div>
                    </div>
                   
                </div>
                <div class="card">
                    <h3>Total Price: ${{ totalPrice }}</h3>
                </div>
                
                <p><strong>First Name:</strong> <input v-model.trim="order.firstName" @input="validateField('firstName')" />
                    <span v-if="errors.firstName" class="error">{{ errors.firstName }}</span>
                </p>
                <p><strong>Last Name:</strong> <input v-model.trim="order.lastName" @input="validateField('lastName')" />
                    <span v-if="errors.lastName" class="error">{{ errors.lastName }}</span>
                </p>
                <p><strong>Phone Number:</strong> <input v-model.number.trim="order.phoneNumber" @input="validateField('phoneNumber')" />
                    <span v-if="errors.phoneNumber" class="error">{{ errors.phoneNumber }}</span>
                </p>
                <p><strong>Address:</strong> <input v-model.trim="order.address" @input="validateField('address')" />
                    <span v-if="errors.address" class="error">{{ errors.address }}</span>
                </p>
                <p><strong>City:</strong> <input v-model.trim="order.city" @input="validateField('city')" />
                    <span v-if="errors.city" class="error">{{ errors.city }}</span>
                </p>
                <p><strong>Emirate:</strong>
                    <select v-model="order.emirate" @change="validateField('emirate')">
                        <option disabled value="">Emirate</option>
                        <option v-for="(emirate, key) in emirates" :value="emirate">{{ key }}</option>
                    </select>
                    <span v-if="errors.emirate" class="error">{{ errors.emirate }}</span>
                </p>
                <p><strong>Zip/Postal Code:</strong> <input v-model.number.trim="order.zip" @input="validateField('zip')" />
                    <span v-if="errors.zip" class="error">{{ errors.zip }}</span>
                </p>
                <p><input type="checkbox" id="gift" v-model="order.gift">
                    <label for="gift">Ship As Gift?</label>
                </p>
                <p>
                    <input type="radio" id="home" value="Home" v-model="order.method">
                    <label for="home">Home</label>
                    <input type="radio" id="business" value="Business" v-model="order.method">
                    <label for="business">Business</label>
                </p>

                <button v-on:click="submitForm" :disabled="cart.length === 0 || hasErrors" class="btn btn-primary">
                    Place Order
                </button>

                <div v-if="cart.length > 0" class="order-info">
                    <h3>Order Information</h3>
                    <p><strong>First Name:</strong> {{ order.firstName }}</p>
                    <p><strong>Last Name:</strong> {{ order.lastName }}</p>
                    <p><strong>Phone Number:</strong> {{ order.phoneNumber }}</p>
                    <p><strong>Address:</strong> {{ order.address }}</p>
                    <p><strong>City:</strong> {{ order.city }}</p>
                    <p><strong>Emirate:</strong> {{ order.emirate }}</p>
                    <p><strong>Zip/Postal Code:</strong> {{ order.zip }}</p>
                    <p><strong>Delivery Method:</strong> {{ order.method }}</p>
                    <p><strong>Ship As Gift:</strong> {{ order.gift ? "Yes" : "No" }}</p>
                </div>
                
            </div>
        </main>
    </div>
    <script src="bookstore.js"></script>
    <script>
        let webstore = new Vue({
            el: '#app',
            data: {
                sitename: "After School Lessons",
                showBook: true,
                searchQuery: "",
                filteredBooks: bookstore, //from now on we should get the data from db not from js file; we have to use fetch in the frontend to get the data from backend URL
                order: {
                    firstName: "",
                    lastName: "",
                    phoneNumber: "",
                    address: "",
                    city: "",
                    zip: "",
                    emirate: "",
                    method: 'Home',
                    gift: false,
                },
                errors: {},
                emirates: {
                    DU: 'Dubai',
                    SJ: 'Sharjah',
                    AD: 'Abu Dhabi',
                },
                bookstore: bookstore,
                cart: [],
                sortBy: 'subject',
                sortOrder: 'asc',
                addedSubjects: []
            },
            computed: {
                cartItemCount() {
                    return this.cart.length;
                },
                totalPrice() {
                    return this.cart.reduce((sum, item) => sum + item.Price, 0).toFixed(2);
                },
                hasErrors() {
                    return Object.keys(this.errors).length > 0;
                }
            },
            mounted(){
                if(sessionStorage.getItem('cartData')){
                    this.loadSessionData();
                }
               
            },
            methods: {
                addToCart(book) {
                    this.cart.push(book);
                    sessionStorage.setItem('cartData',JSON.stringify(this.cart));
                    this.checkSubjects();
                    console.log(this.cart)
                },
                checkSubjects(){
                    var data = new Set(this.cart.map(book => book.subject));
                    this.addedSubjects = Array.from(data);
                    console.log(this.addedSubjects);
                },
                firstBookPicker(subject){
                    return this.cart.find( book => book.subject === subject);
                },
                uniqueBookCount(subject){
                    return this.cart.filter( book => book.subject === subject).length;
                },
                loadSessionData(){
                    var cartData = sessionStorage.getItem('cartData');
                    this.cart = JSON.parse(cartData);
                    this.checkSubjects();
                },
                showCheckout() {
                    this.showBook = !this.showBook;
                },
                submitForm() {
                    sessionStorage.setItem("firstName",this.order.firstName);

                    if (!this.hasErrors) {
                        alert('Order submitted successfully!');
                        window.location.href = 'checkout.html';
                    } else {
                        alert('Please fix the errors before submitting.');
                    }
                },
                canAddToCart(book) {
                    return book.Spaces > this.cartCount(book.subject, book.Location);
                },
                cartCount(subject, Location) {
                    return this.cart.filter(item => item.subject === subject && item.Location === Location).length;
                },
                removeFromCart(subject) {
                    let subjectBooks = this.cart.filter( book => book.subject === subject);
                    subjectBooks.splice(0, 1);
                    this.cart = this.cart.filter( book => book.subject !== subject);
                    this.cart = this.cart.concat(subjectBooks);
                    sessionStorage.setItem('cartData',JSON.stringify(this.cart));
                    console.log(this.cart)
                },
                goHome() {
                    this.showBook = true;
                },
                sortBooks() {
                    const orderMultiplier = this.sortOrder === 'asc' ? 1 : -1;
                    this.filteredBooks.sort((a, b) => {
                        if (a[this.sortBy] < b[this.sortBy]) return -1 * orderMultiplier;
                        if (a[this.sortBy] > b[this.sortBy]) return 1 * orderMultiplier;
                        return 0;
                    });
                },
                filterBooks() {
                    const query = this.searchQuery.toLowerCase();
                    this.filteredBooks = this.bookstore.filter(book =>
                        book.subject.toLowerCase().includes(query) ||
                        book.Location.toLowerCase().includes(query)
                    );
                },
                placeOrder() {
                    Object.keys(this.order).forEach(this.validateField);

                    if (Object.keys(this.errors).length === 0) {
                        this.orderPlaced = true;
                    }
                },
                validateField(field) {
                    switch (field) {
                        case 'firstName':
                            this.errors.firstName = !this.order.firstName ? 'First Name is required.' : '';
                            break;
                        case 'lastName':
                            this.errors.lastName = !this.order.lastName ? 'Last Name is required.' : '';
                            break;
                        case 'phoneNumber':
                            this.errors.phoneNumber = !this.order.phoneNumber || isNaN(this.order.phoneNumber) ? 'Valid Phone Number is required.' : '';
                            break;
                        case 'address':
                            this.errors.address = !this.order.address ? 'Address is required.' : '';
                            break;
                        case 'city':
                            this.errors.city = !this.order.city ? 'City is required.' : '';
                            break;
                        case 'emirate':
                            this.errors.emirate = !this.order.emirate ? 'Please select an emirate.' : '';
                            break;
                        case 'zip':
                            this.errors.zip = !this.order.zip || isNaN(this.order.zip) ? 'Valid Zip/Postal Code is required.' : '';
                            break;
                        default:
                            break;
                    }
                },

            }
        });
    </script>
</body>

</html>





